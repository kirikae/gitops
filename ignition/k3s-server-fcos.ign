{
  "ignition": {
    "version": "3.4.0"
  },
  "passwd": {
    "users": [
      {
        "groups": [
          "wheel",
          "sudo"
        ],
        "name": "core",
        "sshAuthorizedKeys": [
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE3vtgb3no7isiGKccMl3lfQQcy2P8hJEEtlEeU6/yHw kirikae@ceres.home.cs-network.org"
        ]
      }
    ]
  },
  "storage": {
    "disks": [
      {
        "device": "/dev/disk/by-id/coreos-boot-disk",
        "partitions": [
          {
            "label": "root",
            "number": 4,
            "resize": true,
            "sizeMiB": 8192
          },
          {
            "label": "var",
            "sizeMiB": 0
          }
        ],
        "wipeTable": false
      }
    ],
    "files": [
      {
        "path": "/etc/yum.repos.d/kubernetes.repo",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/4zNsQoCMRAE0D7fYZssVoJwX+AniMXe3rAHSW6X5FLc34so2toNw/DmnseMtmFHf4SNK6bbtwgzd4xWpnXfvV+JnCWzoicpNpakZlqQxCodo1KDW6efF1Eu8fQyuMkasPFcsEznoK6yQvI7Zhx/Hiwm1LzGzypmHEldwzMAAP//9AAYXMQAAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/yum.repos.d/rancher-k3s-common.repo",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3TNsa7CMAyF4T1P0fHeoTVVF4SUiZGNFSGUGqup0sSRnQ59e1SC2Bit7+j3TVxCT9KGQVvkGDm1Wty40N0kF8leqzeXQZvz25u/Ovg3o1NaZbG+lKwnAMmx+/S6mSEMCnUKtQxIqbDCERI7QW8o7fq0vZnyhJ4w2N4IZX5878NOgbZfT/I6LjN2gTbzCgAA//90QUSlzAAAAA=="
        },
        "mode": 420
      },
      {
        "path": "/etc/rancher/k3s/kubelet.config",
        "contents": {
          "compression": "",
          "source": "data:,apiVersion%3A%20kubelet.config.k8s.io%2Fv1beta1%0Akind%3A%20KubeletConfiguration%0AshutdownGracePeriod%3A%2060s%0APeriodCriticalPods%3A%2010s%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/rancher/k3s/config.yaml.d/00-server.yaml",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/2TOTXKEIBDF8X2fgpo9jQrKhNu00CZdOpLiI7l+ykpcZft+/8WLR6+Ni5ZTWlCtdIaWdz6DShNtK3lyc0xzmjdy9m3xnqzzs2V6wneRxnrvK8d8bvIelPnILzYxFzZ47eYX/pX6lRMHtTgH7ai60hlAqwd9Cu62YtQVqT8gSaX14Msqly+JfKygVSvEm+xwX4+SSlDjgOP0xAEHMy7w19/mJ7TDbT8BAAD//05/8C3zAAAA"
        },
        "mode": 420
      },
      {
        "path": "/var/lib/rancher/k3s/server/manifests/kube-vip.yaml",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/6xWUW/jNgx+z68Q8lznmvbusPktuxbDAVtQNMX2MAwBIzGOFlnSKCptNuy/D7Idx4mdIhuuD0VM8+NHUh9pgde/IAXtbC5209FWW5WLBdJOS5xJ6aLlUYkMChjykRAWSszFNq4w22nfGIIHebCGfWAsR1mWjbqxaQVyApE3jvRfwNrZyfa7MNHuQ8v6xcTASM/O4AklWOu4goT0KAZjxRWSRcYqJER20StgzMWYKeK4zbxOLz8UkFFio2iwip0J8PpHctGHXPw2Hv9e82FwkSRWtlD3JoxvRPv7Q2DgWJnQKu+05dBgd0irCmd04PHNuMD0/xVYbpJ7nWXlewW3dQr/W+AbMfaVaYBBOkdK2+5hDJEahHCJVdS0YohXEtalJSn0TvgHbZW2xfUa6Yvw/ChXTch0pM+4rqTT1PtO7JEQffm9q5YQV3+g5JCPMjE4L/9/SsD7cByIB8DS2QWeTqCBFZpmEsD7M+mfMmcqXPDbtUN/O/k8ue/lXCMvpB08ypRAQIOSHdXJlEkDP3WyuzY/xtKbNKx1mE6t6a/SkXb2RZcYGEqfCxuNad6aE77rO3JtV4Q4FFsh1mttNe+PfGkkZz1rGqE/oyZUD5G0LRZygyoabYuvhXWt+fENZUy1dZF1zEXT2hekMpy+zupOP755whCOa7HrscV9XsWpJHtWZQlJ6GcYIZxHgnSa4vFNBw7fllQ6y+RM5g1YvJY7gUBbpJYtE0BFhzvlZaHolIN2131dH/9O+yWQ7/DuwMTu5+HU3zviAefPHz/ejweDa8tIa5DYR6H103A7iJJa0QDN/V2fRPolWlgZvLoG6Zft/PZB3XkeSk0pGwao1mACDrfAICikSrfa2avTbKAB02Mf5Y1VlEmfGSe3l8EqElyg/TTMSWjxVSEoo+1QU+8vwZj2Hkk7NQCa9kGgVBqZvvP0dnI7+X7yqS8+ciXyBmNYphsGDkgkv5tO71qzLqHAXBQbSWnUDruu/ZF31lnr/xSNeXJGy30uZuYV9scUe5+vw05rrwV//9NaA8pImvdfnGV84+5akOBhpY1mjWfrApQ6X2rzx5fl7OHnr/MB+/Ps18a6cYHnyK+OtrlIghodsuh+gudDBbAzSN17ZIqO6zVKzsXcNTv6KIULO6mLqRf4u5D6QrRgAsZiX3Xu3wAAAP//qA/xEHQLAAA="
        },
        "mode": 384
      },
      {
        "overwrite": true,
        "path": "/usr/local/bin/k3s",
        "contents": {
          "source": "https://github.com/k3s-io/k3s/releases/download/v1.28.3%2Bk3s2/k3s",
          "verification": {
            "hash": "sha256-9579caa9218d91614cf5779eb48749bfe5db95e11977cff70e65ee1a96056c88"
          }
        },
        "mode": 493
      }
    ],
    "filesystems": [
      {
        "device": "/dev/disk/by-partlabel/var",
        "format": "xfs",
        "path": "/var",
        "wipeFilesystem": false
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "contents": "# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-var.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-var.service\n\n[Mount]\nWhere=/var\nWhat=/dev/disk/by-partlabel/var\nType=xfs\n\n[Install]\nRequiredBy=local-fs.target",
        "enabled": true,
        "name": "var.mount"
      },
      {
        "contents": "[Unit]\nDescription=Install k3s dependencies\nWants=network-online.target\nAfter=network-online.target\nBefore=zincati.service\nBefore=shutdown.target\nBefore=k3s.service\nDefaultDependencies=no\nConditionPathExists=|!/usr/bin/kubectl\nConditionPathExists=|!/usr/share/selinux/packages/k3s.pp\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=rpm-ostree install --apply-live --allow-inactive --assumeyes kubectl k3s-selinux\nExecStartPost=/usr/sbin/reboot\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "rpm-ostree-install-k3s-dependencies.service"
      },
      {
        "contents": "[Unit]\nDescription=Run K3s\nWants=network-online.target\nAfter=network-online.target\nWants=rpm-ostree-install-k3s-dependencies.service\nAfter=rpm-ostree-install-k3s-dependencies.service\n\n[Service]\nType=notify\nEnvironmentFile=-/etc/default/%N\nEnvironmentFile=-/etc/sysconfig/%N\nEnvironmentFile=-/etc/systemd/system/%N.env\nKillMode=process\nDelegate=yes\nLimitNOFILE=1048576\nLimitNPROC=infinity\nLimitCORE=infinity\nTasksMax=infinity\nTimeoutStartSec=0\nRestart=always\nRestartSec=5s\nExecStartPre=-/sbin/modprobe br_netfilter\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/k3s server --kubelet-arg=\"config=/etc/rancher/k3s/kubelet.config\"\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "k3s.service"
      },
      {
        "contents": "[Unit]\nDescription=Cleanup pods terminated by node shutdown\nWants=k3s.service\n\n[Service]\nType=oneshot\nEnvironment=KUBECONFIG=/etc/rancher/k3s/k3s.yaml\nExecStart=kubectl delete pods --field-selector status.phase=Failed -A --ignore-not-found=true\nRestart=on-failure\nRestartSec=30\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "k3s-cleanup-shutdown-pods.service"
      }
    ]
  }
}
